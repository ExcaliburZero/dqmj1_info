from typing import List, Tuple, Union

BYTE_TO_CHAR_MAP_NA_AND_EU = {
    0x00: "0",
    0x01: "1",
    0x02: "2",
    0x03: "3",
    0x04: "4",
    0x05: "5",
    0x06: "6",
    0x07: "7",
    0x08: "8",
    0x09: "9",
    0x0A: " ",
    0x0B: "A",
    0x0C: "B",
    0x0D: "C",
    0x0E: "D",
    0x0F: "E",
    0x10: "F",
    0x11: "G",
    0x12: "H",
    0x13: "I",
    0x14: "J",
    0x15: "K",
    0x16: "L",
    0x17: "M",
    0x18: "N",
    0x19: "O",
    0x1A: "P",
    0x1B: "Q",
    0x1C: "R",
    0x1D: "S",
    0x1E: "T",
    0x1F: "U",
    0x20: "V",
    0x21: "W",
    0x22: "X",
    0x23: "Y",
    0x24: "Z",
    0x25: "a",
    0x26: "b",
    0x27: "c",
    0x28: "d",
    0x29: "e",
    0x2A: "f",
    0x2B: "g",
    0x2C: "h",
    0x2D: "i",
    0x2E: "j",
    0x2F: "k",
    0x30: "l",
    0x31: "m",
    0x32: "n",
    0x33: "o",
    0x34: "p",
    0x35: "q",
    0x36: "r",
    0x37: "s",
    0x38: "t",
    0x39: "u",
    0x3A: "v",
    0x3B: "w",
    0x3C: "x",
    0x3D: "y",
    0x3E: "z",
    0x55: "Ãœ",
    0x57: "Ã¡",
    0x70: "!",
    0x71: "?",
    0x87: "+",
    0x8D: "â…¡",
    0x8E: "â…¢",
    0x9A: "â€˜",
    0x9B: "â€™",
    0xAC: ".",
    0xAD: "&",
    0xCC: "-",
    0xCD: ",",
    0xFE: "\\n",
}

BYTE_TO_CHAR_MAP = [
    ([0x00], "0"),
    ([0x01], "1"),
    ([0x02], "2"),
    ([0x03], "3"),
    ([0x04], "4"),
    ([0x05], "5"),
    ([0x06], "6"),
    ([0x07], "7"),
    ([0x08], "8"),
    ([0x09], "9"),
    ([0x0a], "A"),
    ([0x0b], "B"),
    ([0x0c], "C"),
    ([0x0d], "D"),
    ([0x0e], "E"),
    ([0x0f], "F"),
    ([0x10], "G"),
    ([0x11], "H"),
    ([0x12], "I"),
    ([0x13], "J"),
    ([0x14], "K"),
    ([0x15], "L"),
    ([0x16], "M"),
    ([0x17], "N"),
    ([0x18], "O"),
    ([0x19], "P"),
    ([0x1a], "Q"),
    ([0x1b], "R"),
    ([0x1c], "S"),
    ([0x1d], "T"),
    ([0x1e], "U"),
    ([0x1f], "V"),
    ([0x20], "W"),
    ([0x21], "X"),
    ([0x22], "Y"),
    ([0x23], "Z"),
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ([0x24], "ã‚"),
    ([0x25], "ã"),
    ([0x26], "ã„"),
    ([0x27], "ãƒ"),
    ([0x28], "ã†"),
    ([0x29], "ã…"),
    ([0x2A], "ãˆ"),
    ([0x2B], "ã‡"),
    ([0x2C], "ãŠ"),
    ([0x2D], "ã‰"),
    # k-
    ([0x2E], "ã‹"),
    ([0x92, 0x2E], "ãŒ"),
    ([0x2F], "ã"),
    ([0x92, 0x2F], "ãŽ"),
    ([0x30], "ã"),
    ([0x92, 0x30], "ã"),
    ([0x31], "ã‘"),
    ([0x92, 0x31], "ã’"),
    ([0x32], "ã“"),
    ([0x92, 0x32], "ã”"),
    # s-
    ([0x33], "ã•"),
    ([0x92, 0x33], "ã–"),
    ([0x34], "ã—"),
    ([0x92, 0x34], "ã˜"),
    ([0x35], "ã™"),
    ([0x92, 0x35], "ãš"),
    ([0x36], "ã›"),
    ([0x92, 0x36], "ãœ"),
    ([0x37], "ã"),
    ([0x92, 0x37], "ãž"),
    # t-
    ([0x38], "ãŸ"),
    ([0x92, 0x38], "ã "),
    ([0x39], "ã¡"),
    ([0x92, 0x39], "ã¢"),
    ([0x3A], "ã¤"),
    ([0x92, 0x3A], "ã¥"),
    ([0x3B], "ã£"),
    ([0x3C], "ã¦"),
    ([0x92, 0x3C], "ã§"),
    ([0x3D], "ã¨"),
    ([0x92, 0x3D], "ã©"),
    # n-
    ([0x3E], "ãª"),
    ([0x3F], "ã«"),
    ([0x40], "ã¬"),
    ([0x41], "ã­"),
    ([0x42], "ã®"),
    # h-
    ([0x43], "ã¯"),
    ([0x92, 0x43], "ã°"),
    ([0x93, 0x43], "ã±"),
    ([0x44], "ã²"),
    ([0x92, 0x44], "ã³"),
    ([0x93, 0x44], "ã´"),
    ([0x45], "ãµ"),
    ([0x92, 0x45], "ã¶"),
    ([0x93, 0x45], "ã·"),
    ([0x46], "ã¸"),
    ([0x92, 0x46], "ã¹"),
    ([0x93, 0x46], "ãº"),
    ([0x47], "ã»"),
    ([0x92, 0x47], "ã¼"),
    ([0x93, 0x47], "ã½"),
    # m-
    ([0x48], "ã¾"),
    ([0x49], "ã¿"),
    ([0x4A], "ã‚€"),
    ([0x4B], "ã‚"),
    ([0x4C], "ã‚‚"),
    # y-
    ([0x4D], "ã‚„"),
    ([0x4E], "ã‚ƒ"),
    ([0x4F], "ã‚†"),
    ([0x50], "ã‚…"),
    ([0x51], "ã‚ˆ"),
    ([0x52], "ã‚‡"),
    # r-
    ([0x53], "ã‚‰"),
    ([0x54], "ã‚Š"),
    ([0x55], "ã‚‹"),
    ([0x56], "ã‚Œ"),
    ([0x57], "ã‚"),
    # w-
    ([0x58], "ã‚"),
    ([0x59], "ã‚’"),
    # n
    ([0x5A], "ã‚“"),
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ([0x5B], "ã‚¢"),
    ([0x5C], "ã‚¡"),
    ([0x5D], "ã‚¤"),
    ([0x5E], "ã‚£"),
    ([0x5F], "ã‚¦"),
    ([0x5F], "ã‚¦"),
    ([0x60], "ã‚¥"),
    ([0x61], "ã‚¨"),
    ([0x62], "ã‚§"),
    ([0x63], "ã‚ª"),
    ([0x64], "ã‚©"),
    # K-
    ([0x65], "ã‚«"),
    ([0x92, 0x65], "ã‚¬"),
    ([0x66], "ã‚­"),
    ([0x92, 0x66], "ã‚®"),
    ([0x67], "ã‚¯"),
    ([0x92, 0x67], "ã‚°"),
    ([0x68], "ã‚±"),
    ([0x92, 0x68], "ã‚²"),
    ([0x69], "ã‚³"),
    ([0x92, 0x69], "ã‚´"),
    # S-
    ([0x6A], "ã‚µ"),
    ([0x92, 0x6A], "ã‚¶"),
    ([0x6B], "ã‚·"),
    ([0x92, 0x6B], "ã‚¸"),
    ([0x6C], "ã‚¹"),
    ([0x92, 0x6C], "ã‚º"),
    ([0x6D], "ã‚»"),
    ([0x92, 0x6D], "ã‚¼"),
    ([0x6E], "ã‚½"),
    ([0x92, 0x6E], "ã‚¾"),
    # T-
    ([0x6F], "ã‚¿"),
    ([0x92, 0x6F], "ãƒ€"),
    ([0x70], "ãƒ"),
    ([0x92, 0x70], "ãƒ‚"),
    ([0x71], "ãƒ„"),
    ([0x72], "ãƒƒ"),
    ([0x73], "ãƒ†"),
    ([0x92, 0x73], "ãƒ‡"),
    ([0x74], "ãƒˆ"),
    ([0X92, 0x74], "ãƒ‰"),
    ([0X93, 0x74], "ãƒˆã‚š"),
    # N-
    ([0x75], "ãƒŠ"),
    ([0x76], "ãƒ‹"),
    ([0x77], "ãƒŒ"),
    ([0x78], "ãƒ"),
    ([0x79], "ãƒŽ"),
    # H-
    ([0x7A], "ãƒ"),
    ([0x92, 0x7A], "ãƒ"),
    ([0x93, 0x7A], "ãƒ‘"),
    ([0x7B], "ãƒ’"),
    ([0x92, 0x7B], "ãƒ“"),
    ([0x93, 0x7B], "ãƒ”"),
    ([0x7C], "ãƒ•"),
    ([0x92, 0x7C], "ãƒ–"),
    ([0x93, 0x7C], "ãƒ—"),
    ([0x7D], "ãƒ"),
    ([0x92, 0x7D], "ãƒ"),
    ([0x93, 0x7D], "ãƒ‘"),
    ([0x7E], "ãƒ›"),
    ([0x92, 0x7E], "ãƒœ"),
    ([0x93, 0x7E], "ãƒ"),
    # M-
    ([0x7F], "ãƒž"),
    ([0x80], "ãƒŸ"),
    ([0x81], "ãƒ "),
    ([0x82], "ãƒ¡"),
    ([0x83], "ãƒ¢"),
    # Y-
    ([0x84], "ãƒ¤"),
    ([0x85], "ãƒ£"),
    ([0x86], "ãƒ¦"),
    ([0x87], "ãƒ¥"),
    ([0x88], "ãƒ¨"),
    ([0x89], "ãƒ§"),
    # R-
    ([0x8A], "ãƒ©"),
    ([0x8B], "ãƒª"),
    ([0x8C], "ãƒ«"),
    ([0x8D], "ãƒ¬"),
    ([0x8E], "ãƒ­"),

    # N
    ([0x8F], "ãƒ¯"),
    ([0x90], "ãƒ²"),
    ([0x91], "ãƒ³"),

    ([0x94], "ã€‚"),
    ([0x95], "ã€Œ"),
    ([0x96], "ã€"),
    ([0x97], "ã€Ž"),
    ([0x98], "ã€"),
    ([0x99], "â€œ"),
    ([0x9A], "â€"),
    ([0x9B], "?"),
    ([0x9C], "!"),
    ([0x9D], "ð… "),
    ([0x9E], "â™¥"),
    ([0xA0], "."),
    ([0xA1], "ãƒ¼"),
    ([0xA2], "~"),
    ([0xA3], "/"),
    ([0xA4], "*"),
    ([0xA5], "("),
    ([0xA6], ")"),
    ([0xA7], "+"),
    ([0xA8], ":"),
    ([0xA9], "â€¦"),

    ([0xBF], " "),

    ([0xb6], "å³¶"),
	([0xe0, 0x02], "ä½•"),
	([0xe0, 0x04], "æŠ€"),
	([0xe0, 0x09], "è¨€"),
	([0xe0, 0x1a], "æœŸ"),
	([0xe0, 0x1f], "ä¿¡"),
	([0xe0, 0x27], "åˆ†"),
	([0xe0, 0x28], "å®‰"),
	([0xe0, 0x32], "ç”»"),
	([0xe0, 0x33], "ä¼š"),
	([0xe0, 0x34], "å›ž"),
	([0xe0, 0x36], "é–‹"),
	([0xe0, 0x37], "å¤–"),
	([0xe0, 0x3b], "é–“"),
	([0xe0, 0x3d], "æ°—"),
	([0xe0, 0x40], "ç©¶"),
	([0xe0, 0x42], "å¼·"),
	([0xe0, 0x46], "è¨ˆ"),
	([0xe0, 0x47], "æ±º"),
	([0xe0, 0x49], "ç ”"),
	([0xe0, 0x4a], "è¦‹"),
	([0xe0, 0x4e], "è¡Œ"),
	([0xe0, 0x51], "ä»Š"),
	([0xe0, 0x52], "æœ€"),
	([0xe0, 0x5c], "æŒ‡"),
	([0xe0, 0x5d], "ç§"),
	([0xe0, 0x60], "æ™‚"),
	([0xe0, 0x61], "æ¬¡"),
	([0xe0, 0x62], "è‡ª"),
	([0xe0, 0x63], "å¼"),
	([0xe0, 0x65], "æ‰‹"),
	([0xe0, 0x66], "ç¨®"),
	([0xe0, 0x68], "å‡º"),
	([0xe0, 0x6b], "æ‰€"),
	([0xe0, 0x6c], "å‹"),
	([0xe0, 0x6e], "å ´"),
	([0xe0, 0x70], "å¿ƒ"),
	([0xe0, 0x73], "èº«"),
	([0xe0, 0x75], "äºº"),
	([0xe0, 0x7d], "é¸"),
	([0xe0, 0x7e], "å‰"),
	([0xe0, 0x84], "ç›¸"),
	([0xe0, 0x85], "æ—"),
	([0xe0, 0x8b], "å¤§"),
	([0xe0, 0x8e], "åœ°"),
	([0xe0, 0x90], "ä¸­"),
	([0xe0, 0x91], "ä»²"),
	([0xe0, 0x92], "é•·"),
	([0xe0, 0x99], "åº¦"),
	([0xe0, 0x9c], "é—˜"),
	([0xe0, 0x9d], "å‹•"),
	([0xe0, 0xa0], "æ—¥"),
	([0xe0, 0xa2], "ä»»"),
	([0xe0, 0xa6], "ç™º"),
	([0xe0, 0xa9], "åŒ¹"),
	([0xe0, 0xae], "èž"),
	([0xe0, 0xb3], "æ–¹"),
	([0xe0, 0xb7], "å"),
	([0xe0, 0xbc], "å½¹"),
	([0xe0, 0xbd], "å„ª"),
	([0xe0, 0xc0], "æ§˜"),
	([0xe0, 0xc1], "ç”¨"),
	([0xe0, 0xc3], "ä»¤"),
	([0xe0, 0xc9], "å¿…"),
	([0xe0, 0xe5], "è«¸"),
	([0xe0, 0xf9], "å‹™"),
	([0xe0, 0xfc], "æ€"),
	([0xe0, 0xfd], "çŸ¥"),

	([0xe0, 0xe0], "[0xe0][0xe0]"),
	([0xe0, 0xe1], "[0xe0][0xe1]"),
	([0xe0, 0xb8], "[0xe0][0xb8]"),
	([0xe0, 0x2c], "[0xe0][0x2c]"),
	([0xe0, 0x2d], "[0xe0][0x2d]"),
	([0xe0, 0xba], "[0xe0][0xba]"),
	([0xe0, 0xf1], "[0xe0][0xf1]"),
	([0xe0, 0x31], "[0xe0][0x31]"),
	([0xe0, 0x67], "[0xe0][0x67]"),
	([0xe0, 0xbf], "[0xe0][0xbf]"),
	([0xe0, 0x1b], "[0xe0][0x1b]"),
	([0xe0, 0x0e], "[0xe0][0x0e]"),
	([0xe0, 0x5a], "[0xe0][0x5a]"),
	([0xe0, 0x8c], "[0xe0][0x8c]"),
	([0xe0, 0x41], "[0xe0][0x41]"),
	([0xe0, 0x57], "[0xe0][0x57]"),
	([0xe0, 0x2e], "[0xe0][0x2e]"),
	([0xe0, 0x97], "[0xe0][0x97]"),
	([0xe0, 0x5b], "[0xe0][0x5b]"),
	([0xe0, 0x7a], "[0xe0][0x7a]"),

	([0xe0, 0x59], "[0xe0][0x59]"),
	([0xe0, 0x72], "[0xe0][0x72]"),
	([0xe0, 0x94], "[0xe0][0x94]"),
	([0xe0, 0x7c], "[0xe0][0x7c]"),

    ([0xFE], "\\n"),
]

#CHAR_TO_BYTE_MAP = {c: b for b, c in BYTE_TO_CHAR_MAP.items()}
CHAR_TO_BYTE_MAP = {c: b for b, c in BYTE_TO_CHAR_MAP}

def string_to_bytes(string: str) -> bytes:
    try:
        string_bytes = []
        hex_buffer = []
        escape_buffer = []
        for char in string:
            if char == "]":
                char = "".join(hex_buffer[3:])
                string_bytes.append(int(char, 16))
                hex_buffer = []
                continue
            elif char == "[" or len(hex_buffer) > 0:
                hex_buffer.append(char)
                continue
            elif char == "\\":
                escape_buffer += [char]
                continue
            elif len(escape_buffer) > 0:
                char = "".join(escape_buffer) + char
                escape_buffer = []

            matching_bytes = CHAR_TO_BYTE_MAP[char]
            string_bytes.extend(matching_bytes)
    except Exception as e:
        raise ValueError(f'Failed to convert string to bytes: "{string}"') from e

    string_bytes.append(0xFF)

    return bytes(string_bytes)

def bytes_to_string(bs: Union[List[int], bytes]) -> str:
    chars = []
    i = 0
    while i != len(bs):
        b = bs[i]
        if b == 0xFF:
            break

        #chars.append(byte_to_char(b))
        #return "[" + hex(byte) + "]"
        char, i = get_bytes_match(bs, i)
        chars.append(char)

        # i += 1

    return "".join(chars)

def get_bytes_match(bs: Union[List[int], bytes], i: int) -> Tuple[List[Tuple[List[int], str]], int]:
    matches = list(BYTE_TO_CHAR_MAP)
    offset = 0
    while len(matches) >= 1:
        remaining_matches = []
        for match_bytes, match_char in matches:
            if match_bytes[offset] == bs[i + offset]:
                if len(match_bytes) == offset + 1:
                    return match_char, i + offset + 1
                else:
                    remaining_matches.append((match_bytes, match_char))
        matches = remaining_matches

        offset += 1

    #if len(matches) == 1 and len(matches[0][0]) > 1:
    #    print(matches)
    #    print([hex(b) for b in matches[0][0]])
    #    print([hex(b) for b in bs[i:i+offset+1]])
    #    print(offset)
    #    breakpoint()

    if len(matches) == 0 or (len(matches) == 1 and len(matches[0][0]) <= offset):
        return "[" + hex(bs[i]) + "]", i + 1
    elif len(matches) == 1:
        #if len(matches[0][0]) > 1:
        #    breakpoint()
        assert matches[0][0] == bs[i:i + offset], f"{matches[0][0]} != {bs[i:i + offset]}"

        return matches[0][1], i + offset
    else:
        assert False